

#### What is WebRTC?
(Web Real Time Communication)
It is used for exchanging video or, audio in an efficient and, low latency manner.

A scenario: 
![[Pasted image 20240618111710.png]]
WebRTC Basics:
- NAT (Network Address Translations)
- STUN (Session Traversal Utilities for NAT)
- TURN (Traversal Using Relays around NAT)
- ICE (Interactive Connectivity Establishment)
- SDP (Session Description Protocol)
- Signaling SDP

## NAT

### Types of NAT
1. One to one NAT (Full-cone NAT)
2. Address Restricted NAT
3. Post Restricted NAT
4. Symmetric NAT

-> One to one NAT: 
	- Packet to (external IP: Port) on the router always maps to (internal IP: Port) without exceptions

-> Address restricted NAT:
	- Packets to external IP: port on the router always maps to internal IP: port as long as source address from packet matches the table
	- allow if we communicated with the host before

-> Post restricted NAT:
	- Packets to external IP: port on the router always maps to internal ip: port as long as source address and, port from  packet matches the table
	-  allow if we communicated with the host: port before

-> Symmetric NAT:
	- Packet to external IP: port on the router always map internal IP: port as long as source address and, port from packets matches the table
	- Only allow if the full pair match

## STUN (Session Traversal Utilities for NAT)
	- Tell me my public IP address/port through NAT
	- Works for full-cone, port/address restricted NAT
	- Doesn't work for symmetric NAT
	- STUN Server port 3478, 5349 for TLS
	- Cheap to maintain

## STUN Request
	![[Pasted image 20240618114357.png]]

## TURN (Traversal Using Relays around NAT)
	- In case of symmetrical NAT we use TURN
	- It's just a server that relays packets
	- TURN default server port 3478, 5349 for TLS
	- Expensive to maintain and, run
## ICE (Interactive Connectivity Establishment)
	- ICE Collects all available candidates(local IP addresses reflexive addresses -- STUN ones and, relayed addresses - TURN one)
	- Called ICE canditates
	- All the collected addresses are then sent to the remote pear via SDP
 
## SDP (Session Description Protocol)
	- A format that describes candidates newtorking, options, media options, security options and, other stuffs.
	- not really a protcol, it is a format (protocol kina lekhya?)
	- most important concept in WebRTC
	- The goal is to take the SDP generated by a user and, serve it somehow to the other party.

![[Pasted image 20240616181842.png]] 

### SDP Signalling:
	- This helps to send the SDP that we just generated somehow to other party we wish to communicated with
	- Signaling can be done via a tweet, QR Code, whatsapp, websockets, HTTP request. It doesn't matter. Just get that long string to the other party.

## A flow of WebRTC

![[Pasted image 20240618120023.png]]

Code example:
```
## Peer A

 /*
//you can specify a STUN server here

const iceConfiguration = { }
iceConfiguration.iceServers = [];
//turn server
iceConfiguration.iceServers.push({
                urls: 'turn:my-turn-server.mycompany.com:19403',
                username: 'optional-username',
                credentials: 'auth-token'
            })
//stun  server
iceConfiguration.iceServers.push({
                urls: 'stun:stun1.l.google.com:19302' 
            })    

const localConnection = new RTCPeerConnection(iceConfiguration)


*/

const localConnection = new RTCPeerConnection()
 

localConnection.onicecandidate = e =>  {
console.log(" NEW ice candidate!! on localconnection reprinting SDP " )
 console.log(JSON.stringify(localConnection.localDescription))
}


const sendChannel = localConnection.createDataChannel("sendChannel");
 sendChannel.onmessage =e =>  console.log("messsage received!!!"  + e.data )
   sendChannel.onopen = e => console.log("open!!!!");
     sendChannel.onclose =e => console.log("closed!!!!!!");


localConnection.createOffer().then(o => localConnection.setLocalDescription(o) )

```

```
# PEER B
	//set offer const offer = ...
const remoteConnection = new RTCPeerConnection()

remoteConnection.onicecandidate = e =>  {
console.log(" NEW ice candidnat!! on localconnection reprinting SDP " )
 console.log(JSON.stringify(remoteConnection.localDescription) )
}

 
remoteConnection.ondatachannel= e => {

      const receiveChannel = e.channel;
      receiveChannel.onmessage =e =>  console.log("messsage received!!!"  + e.data )
      receiveChannel.onopen = e => console.log("open!!!!");
      receiveChannel.onclose =e => console.log("closed!!!!!!");
      remoteConnection.channel = receiveChannel;

}


remoteConnection.setRemoteDescription(offer).then(a=>console.log("done"))

//create answer
await remoteConnection.createAnswer().then(a => remoteConnection.setLocalDescription(a)).then(a=>
console.log(JSON.stringify(remoteConnection.localDescription)))
//send the anser to the client 
```

```
# Final connection PEER A

//this opens the connection
//set answer const answer = ...
localConnection.setRemoteDescription (answer).then(a=>console.log("done"))
```